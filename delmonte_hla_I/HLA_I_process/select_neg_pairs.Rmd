---
title: "select_neg_pairs"
author: "Fumin Li"
date: "`r Sys.Date()`"
output: html_document
---
# Because of the finding that high TGP may cause low DePTH score, we may want to make the TGP comparable in positive and negative set, hence we choose negative pairs that satisfy these two criterion:

1. The TCR count must be comparable.
2. The hla proportion need to be the same in two sets(i.e. for a specific HLA that appear in one of the positive pairs, its proportion in positive pairs is equal to the proportion in negative pairs.)

# select negative pairs that satisfy criterion 1 and 2:
```{r}
table_name1 <- hla_count$hla[1]
table_name <- gsub("\\*", "_", table_name1)
table_name <- gsub(":", "_", table_name)
temp <- get(table_name)
temp <- temp[order(temp$fisher_oneside_pval), ]
temp <- temp[!grepl("\\*", temp$tcr), ]
rownames(temp) <- NULL
pos_num <- sum(sig_pair$hla == table_name1)
neg_num <- 5*pos_num
temp <- temp[1+pos_num:1144338,]
if (pos_num>0) {
  temp2 <- sig_pair[sig_pair$hla == table_name1,][,c(1,2,3)]
  for (i in 1:pos_num) {
    comparable_count <- temp2[i,3]
    temp3 <- temp[temp$count == comparable_count,]
    if (i == 1) {
      neg_pair_condition_hla_condition_tcr <- temp3[sample(nrow(temp3), 5), ][,c(1,2,3)]
    }
    else{
      temp3 <- temp3[sample(nrow(temp3), 5), ][,c(1,2,3)]
      neg_pair_condition_hla_condition_tcr <- rbind(neg_pair_condition_hla_condition_tcr,temp3)
    }
  }
  neg_pair_condition_hla_condition_tcr$hla_allele <- table_name1
}
for (i in 2:nrow(hla_count)){
  table_name1 <- hla_count$hla[i]
  table_name <- gsub("\\*", "_", table_name1)
  table_name <- gsub(":", "_", table_name)
  temp <- get(table_name)
  temp <- temp[order(temp$fisher_oneside_pval), ]
  temp <- temp[!grepl("\\*", temp$tcr), ]
  rownames(temp) <- NULL
  pos_num <- sum(sig_pair$hla == table_name1)
  neg_num <- 5*pos_num
  temp <- temp[1+pos_num:1144338,]
  if (pos_num>0) {
    temp2 <- sig_pair[sig_pair$hla == table_name1,][,c(1,2,3)]
      for (j in 1:pos_num) {
        comparable_count <- temp2[j,3]
        temp3 <- temp[temp$count == comparable_count,]
        temp3 <- temp3[sample(nrow(temp3), 5), ][,c(1,2,3)]
        temp3$hla_allele <- table_name1
        neg_pair_condition_hla_condition_tcr <- rbind(neg_pair_condition_hla_condition_tcr,temp3)
    }
  }
}
```

# Get the dataform for DePTH
```{r}
neg_pair_condition_hla_condition_tcr$v <- gsub("0", "", neg_pair_condition_hla_condition_tcr$v)
neg_pair_condition_hla_condition_tcr$v<- gsub("\\*", "*0", neg_pair_condition_hla_condition_tcr$v)
```

```{r}
neg_pair_condition_hla_condition_tcr$v <- gsub("C", "", neg_pair_condition_hla_condition_tcr$v)
neg_pair_condition_hla_condition_tcr$v <- gsub("TRBV19-1", "TRBV19", neg_pair_condition_hla_condition_tcr$v)
neg_pair_condition_hla_condition_tcr$v <- gsub("TRBV14-1", "TRBV14", neg_pair_condition_hla_condition_tcr$v)
neg_pair_condition_hla_condition_tcr$v <- gsub("TRBV27-1", "TRBV27", neg_pair_condition_hla_condition_tcr$v)
neg_pair_condition_hla_condition_tcr$v <- gsub("TRBV18-1", "TRBV18", neg_pair_condition_hla_condition_tcr$v)
neg_pair_condition_hla_condition_tcr$v <- gsub("TRBV13-1", "TRBV13", neg_pair_condition_hla_condition_tcr$v)
neg_pair_condition_hla_condition_tcr$v <- gsub("TRBV28-1", "TRBV28", neg_pair_condition_hla_condition_tcr$v)
neg_pair_condition_hla_condition_tcr$v <- gsub("TRBV2-1", "TRBV2", neg_pair_condition_hla_condition_tcr$v)
neg_pair_condition_hla_condition_tcr$v <- gsub("TRBV9-1", "TRBV9", neg_pair_condition_hla_condition_tcr$v)
neg_pair_condition_hla_condition_tcr$v <- gsub("TRBV16-1", "TRBV16", neg_pair_condition_hla_condition_tcr$v)
neg_pair_condition_hla_condition_tcr$v <- gsub("TRBV1-1", "TRBV1", neg_pair_condition_hla_condition_tcr$v)
neg_pair_condition_hla_condition_tcr$v <- gsub("TRBV15-1", "TRBV15", neg_pair_condition_hla_condition_tcr$v)
neg_pair_condition_hla_condition_tcr$v <- gsub("TRBV1-2\\*01", "not_found", neg_pair_condition_hla_condition_tcr$v)
neg_pair_condition_hla_condition_tcr$v <- gsub("TRBV1-3\\*01", "not_found", neg_pair_condition_hla_condition_tcr$v)
neg_pair_condition_hla_condition_tcr$v <- gsub("TRBV6-2\\*02", "not_found", neg_pair_condition_hla_condition_tcr$v)
neg_pair_condition_hla_condition_tcr$v <- gsub("TRBV3-1\\*05", "not_found", neg_pair_condition_hla_condition_tcr$v)
neg_pair_condition_hla_condition_tcr$v <- gsub("TRBV2\\*04", "not_found", neg_pair_condition_hla_condition_tcr$v)
neg_pair_condition_hla_condition_tcr$v <- gsub("TRBV1\\*03", "not_found", neg_pair_condition_hla_condition_tcr$v)
```

```{r}
temp <- neg_pair_condition_hla_condition_tcr[,c(1,2)]
temp$tcr <- paste0(neg_pair_condition_hla_condition_tcr$v,",",neg_pair_condition_hla_condition_tcr$tcr)
temp$hla_allele <- paste0("HLA-",neg_pair_condition_hla_condition_tcr$hla)
temp <- temp[,c(3,1)]
```

```{r}
write.csv(temp, "/Users/fuminli/anaconda3/envs/DePTH_env/immuneaccess_neg.csv")
```

```{r}
neg_pair_condition_hla_condition_tcr_score <- read.csv("/Users/fuminli/anaconda3/envs/DePTH_env/immuneaccess_neg/predicted_scores.csv")

neg_pair_condition_hla_condition_tcr$score <- neg_pair_condition_hla_condition_tcr_score$score
```

